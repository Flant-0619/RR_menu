<!DOCTYPE html>
<html lang="ja">
  <head>
    <mata charset="utf-8"/>
    <title>fabric test</title>
    <link rel="stylesheet" href="test.css">
    <script src="fabric.js"></script>
    <script src="HUB.js"></script>
  </head>
  <body>
    <!-- メニューバー -->
    <header>
      <from>
        <select id = "pzoom" onchange="CallPCanvasZoomMethod(Work_canvas)">
          <option value="kobetu" id = "kobe" disabled>フォント表示</option>
          <option value="50%" id = "font0">50%</option>
          <option value="75%" id = "font1">75%</option>
          <option value="100%" selected id = "font2">100%</option>
          <option value="125%" id = "font3">125%</option>
          <option value="150%" id = "font4">150%</option>
        </select>
        <input type = "button" value = "拡大" id = "font6" onclick = "CallCanvasZoomMethod('ZoomIn', Work_canvas)">
        <input type = "button" value = "縮小" id = "font7" onclick = "CallCanvasZoomMethod('ZoomOut', Work_canvas)">
        <input type = "button" value = "↩" id = "back" disabled onclick = "CallBack(Work_canvas)">
        <input type = "button" value = "↪" id = "rback" disabled onclick = "SendTo(Work_canvas)">
        <input type = "button" value = "削除" onclick = "CallRemoveMethod('Remove', Work_canvas)">
        <input type = "button" value = "全削除" onclick = "CallRemoveMethod('RemoveAll', Work_canvas)">
        <input type = "checkbox" id = "checkbox1" /><label for="checkbox1">グリッド線</label>
        <input type = "button" id= "save" value = "保存" onclick = "CallSaveMethod(Work_canvas)">
      </from>
    </header>
    <!-- パーツウィンドウ -->
    <aside id="left">
      <div class="tabs">
        <input id="all" type="radio" name="tab_item" checked>
        <label class="tab_item" for="all">パーツ</label>
        <input id="programming" type="radio" name="tab_item">
        <label class="tab_item" for="programming">写真</label>
        <input id="design" type="radio" name="tab_item">
        <label class="tab_item" for="design">テンプレ</label>
        <div class="tab_content" id="all_content">
          <h3 id="top">図形</h3></br>
          <from>
            <input type = "image" value = "クリックして！" src = "orange_rect.png" onclick="CallCreateMethod('Rect', Work_canvas)">
            <input type = "image" value = "クリックして！" src = "red_circle.png" onclick="CallCreateMethod('Circle', Work_canvas)"></br>
          </from>
          <h3 id="nomal">機能</h3></br>
          <from>
            <input type = "image" value = "クリックして！" src = "twitter.png" onclick="CallCreateMethod('Twitter', Work_canvas)" width="50" height="50"></br>
          </from>
          <h3 id="nomal">テキスト</h3></br>
          <from>
            <input type = "image" value = "クリックして！" src = "Text.png" onclick="CallCreateMethod('Text', Work_canvas)">
          </from>
        </div>
        <div class="tab_content" id="programming_content">
            写真の内容がここに入ります
        </div>
        <div class="tab_content" id="design_content">
            テンプレートの内容がここに入ります
        </div>
      </div>
    </aside>
    <!-- 編集ウィンドウ -->
    <aside id="right">
      <div class="edittabs">
        <input id="editall" type="radio" name="edittab_item" checked>
        <label class="edittab_item" for="editall">編集</label>
        <input id="editprogramming" type="radio" name="edittab_item">
        <label class="edittab_item" for="editprogramming">リンク設定</label>
        <div class="edittab_content" id="editall_content">
          <from>
            フォント:</br>
            <input type = "button" value = "Text変更" onclick = "CallChangeFont(Work_canvas)"></br>
            カラー:</br>
            パーツの色:<input type = "color" id = "Diagram_color">
            <input type = "button" value = "適用" onclick = "CallColorChange('Diagram', Work_canvas)">
            </br>
            フレーム色:<input type = "color" id = "Frame_color">
            <input type = "button" value = "適用" onclick = "CallColorChange('Frame', Work_canvas)">
            </br>
            配　置:</br>
            <input type = "button" value = "前面へ" onclick = "CallMovelayerMethod('Top', Work_canvas)">
            <input type = "button" value = "背面へ" onclick = "CallMovelayerMethod('Bottom', Work_canvas)"></br>
            x軸:<input type = "number" id = "position_left" value = "0" onfocus="this.select();"></br>
            y軸:<input type = "number" id = "position_top" value = "0" onfocus="this.select();"></br>
            <input type = "button" value = "適用" onclick = "Call_Position_Change(Work_canvas)"></br>
            サイズ:</br>
            <input type = "button" value = "+20%" onclick = "CallObjectZoomMethod('ZoomIn', Work_canvas)"> 
            <input type = "button" value = "-20%" onclick = "CallObjectZoomMethod('ZoomOut', Work_canvas)"></br>
            <input type = "button" value = "Clone"onclick="CallCreateMethod('Clone', Work_canvas)"></br>
            <input type = "file"> 
          </from>
        </div>
        <div class="edittab_content" id="editprogramming_content">
          <from>
            リンクの内容がここに入ります
            <input type = "text" id = "URLBox" value = "">
            <input type = "button" value = "URLを設定する" onclick = "CallSettingMethod()">
          </from>
        </div>
    </aside>
    <!-- キャンバス -->
    <div class="canvastabs">
      <input id="canvasall" type="radio" name="canvastab_item" checked>
      <label class="canvastab_item" for="canvasall">キャンバス1</label>
      <input id="canvasprogramming" type="radio" name="canvastab_item">
      <label class="canvastab_item" for="canvasprogramming">キャンバス2</label>
      <div class="canvastab_content" id="canvasall_content">
        <canvas id="canvas" width="600" height="600" style="border:1px solid;"></canvas>
      </div>
      <div class="canvastab_content" id="canvasprogramming_content">
        <canvas id="canvasC" width="600" height="600" style="border:1px solid;"></canvas>
      </div>
    </div>
    <canvas hidden id="Startup_canvas" width="1400" height="1400" style="border:1px solid;"></canvas>
    <script type = "text/javascript">
      var link_data = [];
      var Select;
      const default_canvas_size = 600;
      </script>

    <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <script type = "text/javascript">var canvasA = new fabric.Canvas('canvas',{preserveObjectStacking: true});</script>
    <script type = "text/javascript">var canvasC = new fabric.Canvas('canvasC',{preserveObjectStacking: true});</script>
    <script type = "text/javascript">
    document.getElementById("Startup_canvas").style.display="none";
    var Startupcanvas = new fabric.Canvas('Startup_canvas');
    </script>
    <script src="create.js"></script>
    <script src="grid.js"></script>
    <script src="save.js"></script>
    <script src= "url.js"></script>
    <script src= "getdata.js"></script>
    <script src= "remove.js"></script>
    <script src= "layer.js"></script>
    <script src= "Canvas_Zoom.js"></script>
    <script src= "obj_Zoom.js"></script>
    <script src= "Back_to_screen.js"></script>
    <script src= "startup.js"></script>
    <script src= "Obj_position.js"></script>
    <script src= "Color_Cange.js"></script>
    <script src= "font.js"></script>
    <script>

      var bool = true;
      var Work_canvas = canvasA;
      Grid_Img = Startup(Work_canvas, Startupcanvas);
      var canvas_size = 600;
      var tmp_undo = [];
      var save = document.getElementById('save');
      $(function(){
  //トグルボタン定義
        $("#checkbox1").button();
        $("#checkbox1").click(function(){
          var a = $("#checkbox1").prop("checked");
          if(a){
            Work_canvas.setBackgroundImage(null, Work_canvas.renderAll.bind(Work_canvas));
            bool = false;
          }else{
            //bool = Work_canvas.add("newImg");
            Work_canvas.setBackgroundImage(Grid_Img, Work_canvas.renderAll.bind(Work_canvas),{left : -300, top : -300});
            bool = true;
          }
        });
      });
      Work_canvas.on('selection:created', function(options) {
        tmp_undo.push(Work_canvas.toDatalessJSON());
        document.getElementById("position_left").value = Select.left;
        document.getElementById("position_top").value = Select.top;
      });
      Work_canvas.on('object:modified', function(option){
        undo.push(tmp_undo.pop());
        redo = [];
        tmp_undo.push(Work_canvas.toDatalessJSON());
        document.getElementById("position_left").value = Select.left;
        document.getElementById("position_top").value = Select.top;
      })  
      Work_canvas.on('selection:updated', function(option){
        document.getElementById("position_left").value = Select.left;
        document.getElementById("position_top").value = Select.top;
      })
      Work_canvas.on('object:moving', function(options) { 
        if(bool == true){
        options.target.set({
          left: Math.round(options.target.left / Smallgrid) * Smallgrid,
          top: Math.round(options.target.top / Smallgrid) * Smallgrid
        });
        }
      });
      Work_canvas.on('object:moving', function(options) { 
        if(Select.left <= 0)
          options.target.set({left:0});
        if(Select.top <= 0)
          options.target.set({top:0});
        if(Select.left + (Select.width * Select.scaleX) >= canvas_size)
          options.target.set({left:canvas_size - (Select.width * Select.scaleX)});
        if(Select.top + (Select.height * Select.scaleY) >= canvas_size)
          options.target.set({top:canvas_size - (Select.height * Select.scaleY)});
      });
      Work_canvas.on('object:scaling', options => {
        if(bool == true){
          var target = options.target,
          ww = (target.width / 10);
          hh = (target.height / 10);
          target.scaleX = (Math.round(target.scaleX * ww)) / ww;
          target.scaleY = (Math.round(target.scaleY * hh)) / hh;
          w = Math.round(target.width * target.scaleX),
          h = Math.round(target.height * target.scaleY),
          snap = { // Closest snapping points
            top: Math.round(target.top / Smallgrid) * Smallgrid,
            left: Math.round(target.left / Smallgrid) * Smallgrid,
            bottom: Math.round((target.top + h) / Smallgrid) * Smallgrid,
            right: Math.round((target.left + w) / Smallgrid) * Smallgrid
          },
          threshold = Smallgrid,
          dist = { // Distance from snapping points
            top: Math.abs(snap.top - target.top),
            left: Math.abs(snap.left - target.left),
            bottom: Math.abs(snap.bottom - target.top - h),
            right: Math.abs(snap.right - target.left - w)
          },
          attrs = {
            scaleX: target.scaleX,
            scaleY: target.scaleY,
            top: target.top,
            left: target.left
          };
        } 
        target.set(attrs);
      });
    </script>
  </body>
</html>